<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estação Meteorológica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {font-family: "Roboto Mono", monospace;background-color: #000;color: #fafafa;}
        .data-card {background-color: #0a0a0a;border-radius: 0.75rem;padding: 1.5rem;border: 1px solid #262626;}
        .btn-card {
            background-color: #000;
            color: #fafafa;
            border: none;
            padding: 0.5rem 2rem;
            border-radius: 0.75rem;
            border: 1px solid #262626;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-16">
    <div class="max-w-7xl mx-auto">
        <section class="mb-8 mt-12">
            <div class="grid grid-cols-1 grid-rows-1 md:grid-cols-2 gap-6">
                <div class="data-card grid grid-cols-1 gap-6">
                    <p class="text-base font-medium text-white flex items-center gap-2">
                        <i class='bxr bx-city'></i>
                        <span id="localization-box">Cidade, Estado</span>
                    </p>
                    <p id="timestamp-data" class="text-5xl font-bold">15:30:34</p>
                </div>

                <div class="grid grid-cols-1 grid-rows-1 md:grid-cols-2 md:grid-rows-2 gap-6">
                    <div class="data-card text-left">
                        <p class="text-base font-medium text-white flex justify-items-center items-center gap-2">
                            <i class='bxr bx-tachometer'></i>
                            <span>Pressão Atmosférica</span>
                        </p>
                        <p id="pressure-box" class="text-2xl font-bold text-green-500 mt-2">20 hPa</p>
                    </div>
                    <div class="data-card text-left">
                        <p class="text-base font-medium text-white flex justify-items-center items-center gap-2">
                            <i class='bxr bx-thermometer'></i>
                            <span>Temperatura</span>
                        </p>
                        <p id="temperature-box" class="text-2xl font-bold text-green-500 mt-2 mb-2">45.6 ºC</p>
                        <span id="temperatura-limits-box" class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-lg dark:bg-blue-900 dark:text-blue-300">MIN: 10 m | MAX: 1255 m</span>
                    </div>
                    <div class="data-card text-left">
                        <p class="text-base font-medium text-white flex justify-items-center items-center gap-2">
                            <i class='bxr bx-water-drop-alt'></i>
                            <span>Umidade</span>
                        </p>
                        <p id="humidity-box" class="text-2xl font-bold text-green-500 mt-2 mb-2">20%</p>
                        <span id="humidity-limits-box" class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-lg dark:bg-blue-900 dark:text-blue-300">MIN: 23% | MAX: 68%</span>
                    </div>
                    <div class="data-card text-left">
                        <p class="text-base font-medium text-white flex justify-items-center items-center gap-2">
                            <i class='bxr bx-mountain-peak'></i>
                            <span>Altitude</span>
                        </p>
                        <p id="altitude-box" class="text-2xl font-bold text-green-500 mt-2">325 m</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <div class="text-xl font-medium text-white flex justify-items-center items-center gap-2 mb-4">
                <i class='bxr bx-chart-line'></i>
                <h2>Histórico de Medições</h2>
            </div>
            <div class="data-card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div id="plots-card-control" class="grid grid-cols-1 gap-2 w-full md:grid-cols-3">
                        <button data-control="pressure" class="btn-card">Pressão</button>
                        <button data-control="temperature" class="btn-card">Temperatura</button>
                        <button data-control="humidity" class="btn-card">Umidade</button>
                    </div>
                </div>
                <div id="plots-card"></div>
            </div>
        </section>

        <section class="mb-8">
            <div class="text-xl font-medium text-white flex justify-items-center items-center gap-2 mb-4">
                <i class='bxr bx-ruler'></i>
                <h2>Definição de Limites</h2>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <div class="data-card grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-1 gap-2">
                        <div class="w-full">
                            <label for="temperature-min" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Temperatura mínima</label>
                            <input type="number" name="temperature-min" id="temperature-min" class="bg-[#000] border border-[#262626] text-gray-900 text-sm rounded-lg block w-full p-2.5 outline-none focus-within:border-gray-700 text-white" placeholder="95 m" required="">
                        </div>
                        <div class="w-full">
                            <label for="temperature-max" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Temperatura máxima</label>
                            <input type="number" name="temperature-max" id="temperature-max" class="bg-[#000] border border-[#262626] text-gray-900 text-sm rounded-lg block w-full p-2.5 outline-none focus-within:border-gray-700 text-white" placeholder="1000 m" required="">
                        </div>
                   </div>
                    <div class="mt-4 grid grid-cols-1 gap-2">
                        <div class="w-full">
                            <label for="humidity-min" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Umidade mínima</label>
                            <input type="number" name="humidity-min" id="humidity-min" class="bg-[#000] border border-[#262626] text-gray-900 text-sm rounded-lg block w-full p-2.5 outline-none focus-within:border-gray-700 text-white" placeholder="20%" required="">
                        </div>
                        <div class="w-full">
                            <label for="humidity-max" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Umidade máxima</label>
                            <input type="number" name="humidity-max" id="humidity-max" class="bg-[#000] border border-[#262626] text-gray-900 text-sm rounded-lg block w-full p-2.5 outline-none focus-within:border-gray-700 text-white" placeholder="65%" required="">
                        </div>
                    </div>
                    <div class="w-full md:flex md:justify-end">
                        <button id="btn-sensors-levels" class="btn-card hover:bg-white hover:text-black hover:border-white w-full md:w-auto"><i class='bxr  bx-refresh-cw'  ></i> Atualizar limites</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Busca a localização
        function getCoordinates() {
            let options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            function success(pos) {
                let crd = pos.coords;
                let lat = crd.latitude.toString();
                let lng = crd.longitude.toString();
                let coordinates = [lat, lng];
                getCity(coordinates);
                return;
            }

            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
            }

            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        function getCity(coordinates) {
            let xhr = new XMLHttpRequest();
            let lat = coordinates[0];
            let lng = coordinates[1];
            xhr.open('GET', "https://us1.locationiq.com/v1/reverse.php?key=pk.090c85adcabfffe9d6032213b1fb1d71&lat=" +
            lat + "&lon=" + lng + "&format=json", true);
            xhr.send();
            xhr.onreadystatechange = processRequest;
            xhr.addEventListener("readystatechange", processRequest, false);
            function processRequest(e) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    let response = JSON.parse(xhr.responseText);
                    document.getElementById('localization-box').textContent = `${response.address.city}, ${response.address.state}`;
                    return;
                }
            }
        }

        getCoordinates();

        // --- CONFIGURAÇÕES E DADOS INICIAIS ---
        let currentMetric = 'temp'; // Métrica ativa no gráfico

        // Dados simulados para o gráfico (começamos com 20 pontos)
        let chartData = {
            temp: Array(20).fill(0),
            humidity: Array(20).fill(0),
            pressure: Array(20).fill(0),
            categories: Array(20).fill(null).map((_, i) => {
                const d = new Date();
                d.setSeconds(d.getSeconds() - (20 - i) * 5);
                return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            })
        };

        let state = {
            maxLimit: 70, // Limite máximo de temperatura
            minLimit: 10  // Limite mínimo de temperatura
        };

        // --- OPÇÕES DO GRÁFICO (APEXCHARTS) ---
        const chartOptions = {
            series: [{
                name: 'Temperatura',
                data: chartData.temp
            }],
            chart: {
                height: 350,
                type: 'area',
                toolbar: { show: false },
                zoom: { enabled: false },
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                }
            },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 3 },
            xaxis: {
                categories: chartData.categories,
                labels: {
                    style: { colors: '#9CA3AF' }
                }
            },
            yaxis: {
                labels: {
                    style: { colors: '#9CA3AF' },
                    formatter: (val) => val.toFixed(1)
                }
            },
            tooltip: {
                theme: 'dark',
                x: {
                    format: 'HH:mm:ss'
                },
            },
            grid: {
                borderColor: '#374151',
                strokeDashArray: 5,
            },
            colors: ['#FBBF24'] // Cor inicial para temperatura (amarelo)
        };

        // Inicializa o gráfico
        const chart = new ApexCharts(document.querySelector("#chart"), chartOptions);
        chart.render();

        // --- FUNÇÕES DE ATUALIZAÇÃO ---
        // Função para atualizar os dados da página
        async function updateData() {
            try {
                const r = await fetch('/api/weather');  // Requisição para o servidor
                const d = await r.json();          // Converte resposta para JSON

                // Atualiza os dados locais
                const newTemp = d.temperature;
                const newHumidity = d.humidity;
                const newPressure = d.pressure;
                const newAltitude = d.altitude;

                // Atualiza limites se mudaram no servidor
                if (d.maxTemperature !== undefined) {
                    state.maxLimit = d.maxTemperature;
                }
                if (d.minTemperature !== undefined) {
                    state.minLimit = d.minTemperature;
                }

                // 2. Atualiza os cards de Condições Atuais
                document.getElementById('temp-value').textContent = `${newTemp} °C`;
                document.getElementById('humidity-value').textContent = `${Math.round(newHumidity)} %`;
                document.getElementById('pressure-value').textContent = `${Math.round(newPressure)} hPa`;

                // 3. Atualiza o card de Altitude
                const altitude = calculateAltitude(newPressure);
                console.log(`Altitude estimada: ${altitude} m`);
                document.getElementById('altitude-value').textContent = `${Math.round(altitude)} m`;

                // 4. Atualiza o timestamp
                const now = new Date();
                document.getElementById('timestamp').textContent = now.toLocaleTimeString('pt-BR');

                // 5. Atualiza os dados do gráfico
                chartData.temp.push(newTemp);
                chartData.humidity.push(newHumidity);
                chartData.pressure.push(newPressure);
                chartData.categories.push(now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));

                // Mantém o gráfico com apenas 20 pontos de dados (efeito de rolagem)
                if (chartData.temp.length > 20) {
                    chartData.temp.shift();
                    chartData.humidity.shift();
                    chartData.pressure.shift();
                    chartData.categories.shift();
                }

                // 6. Atualiza o gráfico com os novos dados da métrica ativa
                updateChartSeries();
            } catch(e) {
                console.error('Erro:', e);
            }
        }

        // Função para trocar a série de dados exibida no gráfico
        function updateChartSeries() {
            let seriesName = '';
            let data = [];
            let color = '';

            switch (currentMetric) {
                case 'humidity':
                    seriesName = 'Umidade';
                    data = chartData.humidity;
                    color = '#38BDF8'; // sky-400
                    break;
                case 'pressure':
                    seriesName = 'Pressão';
                    data = chartData.pressure;
                    color = '#A78BFA'; // violet-400
                    break;
                default: // temp
                    seriesName = 'Temperatura';
                    data = chartData.temp;
                    color = '#FBBF24'; // amber-400
                    break;
            }

            chart.updateOptions({
                xaxis: { categories: chartData.categories },
                colors: [color]
            });
            chart.updateSeries([{ name: seriesName, data: data }]);
        }

        // --- EVENT LISTENERS E INTERVALOS ---

        // Adiciona o evento de clique aos botões de controle do gráfico
        document.getElementById('chart-controls').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                // Remove a classe 'active' de todos os botões
                document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
                // Adiciona a classe 'active' ao botão clicado
                e.target.classList.add('active');

                currentMetric = e.target.dataset.metric;
                updateChartSeries();
            }
        });

        // Inicia a atualização de dados a cada 2 segundos
        setInterval(updateData, 2000);

        // Chama a função uma vez no início para carregar os dados imediatamente
        updateData();

    </script>
</body>
</html>
